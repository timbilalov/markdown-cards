# Markdown Cards Application

A secure, production-ready Markdown Cards application with authentication, rate limiting, comprehensive logging, and cloud storage integration.

## Features

- **Secure Authentication**: HTTP Basic Auth with encrypted credentials
- **Rate Limiting**: 100 requests per hour per IP address
- **HTTPS Enforcement**: Automatic redirect to HTTPS in production
- **Comprehensive Logging**: Detailed access logs for monitoring
- **Security Headers**: Protection against common web vulnerabilities
- **Vercel Deployment**: Optimized for Vercel deployment
- **Cloud Storage Integration**: Yandex Disk integration for file storage and synchronization
- **Offline Support**: Local caching with IndexedDB for offline access
- **Dual Persistence**: Files stored both locally and in the cloud

## Prerequisites

- Node.js (v16 or higher)
- npm or yarn

## Installation

1. Clone the repository:
   ```bash
   git clone <repository-url>
   cd md-cards-app
   ```

2. Install dependencies:
   ```bash
   npm install
   ```

3. Generate admin credentials:
   ```bash
   npm run generate-password
   ```

   This will create a `.env` file with the admin username and hashed password.

## Cloud Storage Integration

The application now supports cloud storage integration with Yandex Disk, providing:

- Automatic synchronization of markdown cards between local storage and cloud
- Offline access with local caching via IndexedDB
- Dual persistence for data redundancy
- Seamless authentication with Yandex OAuth

### Setup

1. Obtain a Yandex Disk OAuth token:
   - Visit [Yandex OAuth](https://oauth.yandex.ru/)
   - Create a new application or use an existing one
   - Request `disk:read` and `disk:write` permissions
   - Generate an OAuth token

2. Configure the application with one of these methods:
   - **Environment Variable**: Add `VITE_YANDEX_DISK_TOKEN=your_token` to your `.env` file
   - **UI Authentication**: Enter your token in the authentication prompt on the main page

### Usage

Once configured, the application will automatically:
- Sync files from your Yandex Disk `md-cards` folder on startup
- Cache files locally for offline access
- Upload changes to the cloud when saving
- Handle network interruptions gracefully

For detailed documentation on the cloud integration, see [cloud-integration-docs.md](cloud-integration-docs.md).

## Development

To run the application in development mode:

```bash
npm run dev
```

The application will be available at `http://localhost:5173`.

## Environment Variables

The application requires the following environment variables:

- `ADMIN_USERNAME`: The admin username for authentication
- `ADMIN_PASSWORD_HASH`: The bcrypt hashed password for the admin user

For cloud storage integration, you can also set:

- `VITE_YANDEX_DISK_TOKEN`: Your Yandex Disk OAuth token (optional, can be entered via UI)
- `VITE_YANDEX_DISK_BASE_PATH`: Base path in Yandex Disk for markdown cards (defaults to `md-cards`)

The admin credentials are automatically generated when you run `npm run generate-password`.
The cloud integration variables can be added to the `.env` file after generation.

## Deployment to Vercel

1. Create a new project on [Vercel](https://vercel.com)

2. Connect your Git repository to Vercel

3. Configure the environment variables in your Vercel project settings:
   - `ADMIN_USERNAME` = `admin`
   - `ADMIN_PASSWORD_HASH` = (the hash generated by the script)

4. Set the build settings:
   - Build Command: `npm run build`
   - Output Directory: `.svelte-kit/output/client`
   - Install Command: `npm install`

5. Deploy the application

## Security Features

### Authentication
The application uses HTTP Basic Authentication to protect all routes. The credentials are:
- Username: `admin`
- Password: (generated during setup)

### Rate Limiting
The application implements rate limiting to prevent abuse:
- 100 requests per hour per IP address
- Automatic blocking of IPs that exceed the limit
- Rate limit headers in responses

### HTTPS Enforcement
In production environments, the application automatically redirects HTTP requests to HTTPS.

### Security Headers
The application includes several security headers to protect against common web vulnerabilities:
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `X-XSS-Protection: 1; mode=block`
- `Strict-Transport-Security: max-age=31536000; includeSubDomains`

## API Endpoints

All endpoints require HTTP Basic Authentication:
- `GET /` - List all cards
- `GET /card/[slug]` - View a specific card
- `POST /api/save` - Save a card
- `GET /api/files` - List all files

Cloud integration endpoints (require Yandex Disk OAuth token):
- `GET /api/cloud/files` - List files from Yandex Disk
- `GET /api/cloud/download` - Download a file from Yandex Disk
- `POST /api/cloud/upload` - Upload a file to Yandex Disk

## Logging

The application logs various events for monitoring and debugging:
- Successful and failed login attempts
- Rate limit exceeded events
- General application events

Logs are output to the console and can be viewed in the Vercel dashboard.

## Best Practices

### Security
- Never commit the `.env` file to version control
- Regularly rotate admin credentials
- Monitor logs for suspicious activity
- Keep dependencies up to date

### Performance
- The application uses efficient middleware with minimal overhead
- Rate limiting prevents resource exhaustion
- Static assets are served directly by Vercel's CDN

### Scalability

- The application is stateless and can be scaled horizontally
- Authentication is stateless (no sessions to manage)
- Rate limiting uses an in-memory store that works well for single instances

### Cloud Integration

- Regularly rotate your Yandex Disk OAuth tokens
- Monitor your Yandex Disk quota to avoid storage issues
- Use the local cache for offline access when network connectivity is unreliable
- Keep both local and cloud storage in sync by regularly saving changes
## Troubleshooting

### Authentication Issues
If you're having trouble with authentication:
1. Verify the `ADMIN_USERNAME` and `ADMIN_PASSWORD_HASH` environment variables are set correctly
2. Generate new credentials with `npm run generate-password`
3. Restart the application
4. If the password hash appears truncated, check that the full hash is being loaded (the application uses a custom environment variable loader to handle long hash values correctly)

### Rate Limiting Issues
If you're being rate limited:
1. The limit is 100 requests per hour per IP
2. Wait for the rate limit to reset
3. Check logs for rate limit events

### Deployment Issues
If you're having trouble deploying to Vercel:
1. Ensure all environment variables are set in the Vercel project settings
2. Check the build logs for errors
3. Verify the build and output directory settings
